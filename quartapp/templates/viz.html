<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Three.js Visualization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="loading">
        <div>Loading Visualization...</div>
        <div class="spinner"></div>
        <div class="loading-hint">If stuck, try the "Open in New Tab" button</div>
    </div>
    
    <div id="error"></div>
    
    <div id="openInTab">
        <button onclick="openInNewTab()" title="Open in new tab for better WebGL compatibility">
            üîó Open in New Tab
        </button>
    </div>
    
    <div id="info">
        <h3>Visualization</h3>
        <p>Points: <span id="pointCount">0</span></p>
        <p class="hint">üí° Drag to rotate ‚Ä¢ Scroll to zoom</p>
    </div>
    
    <div id="container"></div>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    
    <script>
        function openInNewTab() {
            const newWindow = window.open(window.location.href, '_blank');
            if (!newWindow) {
                alert('Pop-up blocked. Please allow pop-ups and try again.');
            }
        }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // Make THREE and OrbitControls globally available for modules
        window.THREE = THREE;
        window.OrbitControls = OrbitControls;
        
        // Import our custom modules
        import { VizSetup } from "{{ url_for('static', filename='js/viz-setup.js') }}";
        import { VizData } from "{{ url_for('static', filename='js/viz-data.js') }}";
        
        function showError(message, isWebGLError = false) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = `
                <div class="error-content">
                    <h3>‚ö†Ô∏è Initialization Failed</h3>
                    <p><strong>Error:</strong> ${message}</p>
                    
                    ${isWebGLError ? `
                        <h4>Try these solutions:</h4>
                        <ol>
                            <li><strong>Click "Open in New Tab"</strong> button (top right) ‚ú®</li>
                            <li>Enable hardware acceleration in your browser</li>
                            <li>Try Chrome if using another browser</li>
                            <li>Check WebGL status: <a href="chrome://gpu" target="_blank">chrome://gpu</a></li>
                        </ol>
                    ` : `
                        <p>Try refreshing the page or opening in a new tab.</p>
                    `}
                </div>
            `;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
        
        async function init() {
            try {
                console.log('üöÄ Starting initialization...');
                
                // Load data
                const response = await fetch("{{ url_for('get_data') }}");
                
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load data');
                }
                
                const data = result.data;
                console.log('‚úÖ Data loaded:', data.length, 'points');
                
                // Update UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('info').style.display = 'block';
                document.getElementById('pointCount').textContent = data.length;
                
                // Setup Three.js scene with enhanced error handling
                const vizSetup = new VizSetup({
                    backgroundColor: 0x0a0a0a,
                    enableHelpers: true,
                    enableGrid: true,
                    maxPixelRatio: 2
                });
                
                const { scene, camera, renderer, controls } = vizSetup.setup('container');
                console.log('‚úÖ Three.js scene initialized');
                
                // Create visualization from data
                const vizData = new VizData(scene);
                vizData.visualize(data, {
                    showPoints: true,
                    showSpheres: true,
                    showLines: false,
                    sphereSpacing: 5
                });
                
                // Start animation loop
                vizSetup.startAnimation(scene, camera, renderer, controls);
                console.log('‚úÖ Animation started');
                
                // Hide "Open in New Tab" button after successful load
                setTimeout(() => {
                    const tabButton = document.getElementById('openInTab');
                    if (tabButton) {
                        tabButton.style.opacity = '0.5';
                        tabButton.style.pointerEvents = 'auto';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                
                const isWebGLError = error.message.toLowerCase().includes('webgl') ||
                                   error.message.toLowerCase().includes('context') ||
                                   error.message.toLowerCase().includes('renderer');
                
                showError(error.message, isWebGLError);
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
